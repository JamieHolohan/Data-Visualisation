<! doctype html>
<html>

<head>
	<title> Data Visualisation Assignment </title>
	<meta charset="UTF-8">
	<script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
	<script>
	
		// set the dimensions and margins of the graph
		var margin = {top: 20, right: 20, bottom: 50, left: 20},
			width = 1530 - margin.left - margin.right,
			height = 2230 - margin.top - margin.bottom;
			
		// parse the dates in the proper format
		var formatDate = d3.timeFormat("%m/%d/%Y %X");
		var parseDate = d3.timeParse("%m/%e/%y %X");
			
		// Chart 1: append the svg object to the body of the page
		// appends a 'group' element to 'svg'
		// moves the 'group' element to the top left margin
		var svg = d3.select("body")
						.append("svg")
							.attr("width", width + margin.left + margin.right)
							.attr("height", height + margin.top + margin.bottom)
						.append("g")
							.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		
		//Create Pattern for background Image
		svg.append("defs")
			.append("pattern")
			.attr("id", "bg")
			.attr('patternUnits', 'userSpaceOnUse')
			.attr("width" , 720)
			.attr("height" , 720)
			.append("image")
				.attr("width" , 720)
				.attr("height" , 720)
				.attr("xlink:href", "Images/MapLargeLabels.jpg");
				
		//Create Pattern for background Image
		svg.append("defs")
			.append("pattern")
			.attr("id", "bg1")
			.attr('patternUnits', 'userSpaceOnUse')
			.attr("width" , 720)
			.attr("height" , 720)
			.attr("patternTransform", "translate(360, 0)")
			.append("image")
				.attr("width" , 720)
				.attr("height" , 720)
				.attr("xlink:href", "Images/MapLargeLabels.jpg");
				

		//Create Pattern for wind Image
		svg.append("defs")
			.append("pattern")
			.attr("id", "bgwind")
			.attr('patternUnits', 'userSpaceOnUse')
			.attr("width" , 720)
			.attr("height" , 720)
			.append("image")
				.attr("width" , 720)
				.attr("height" , 720)
				.attr("xlink:href", "Images/MapWind.jpg");
			
		//Create Rect top left containing background image
		var image1 = svg.append("rect")
						.attr("id", "rect1")
						.attr("x", 0)
						.attr("y", 0)
						.attr("width" , 720)
						.attr("height" , 720)
						.attr("fill", "url(#bg)");
		
		//Create Rect top right containing wind image
		var image2 = svg.append("rect")
							.attr("id", "rect2")
							.attr("x", 720)
							.attr("y", 0)
							.attr("width" , 720)
							.attr("height" , 720)
							.attr("fill", "url(#bgwind)");
			
		//Create Rect bottom containing map
		var image3 = svg.append("rect")
							.attr("id", "rect3")
							.attr("x", 360)
							.attr("y", 720)
							.attr("width" , 720)
							.attr("height" , 720)
							.attr("fill", "url(#bg1)");
		

		//Compass for wind Image
		var compassVertical = svg.append("line")   
									.style("stroke", "black")
									.attr("stroke-width", 2 )
									.attr("x1", 1390)
									.attr("y1", 30)
									.attr("x2", 1390)
									.attr("y2", 90);
				
		var compassHorizontal = svg.append("line")   
									.style("stroke", "black")
									.attr("stroke-width", 2 )
									.attr("x1", 1360)
									.attr("y1", 60)
									.attr("x2", 1420)
									.attr("y2", 60);
				
		var compassIcon = svg.append("text")   
								.attr("font-size", 10)
								.attr("font-weight", "bold")
								.attr("fill", "red")
								.attr("x", 1390)
								.attr("y", 25)
								.style("text-anchor", "middle")
								.text("N");
		
		//Create Windspeed Indicator
		var winspeedText = svg.append("text")
								.attr("font-size", 20)
								.attr("font-weight", "bold")
								.attr("fill", "black")
								.attr("x", 1230)
								.attr("y", 30)
								.style("text-anchor", "middle")
								.text("Wind Speed: ");
		
		// Read Data from file in local repository
		d3.csv("Data/MeteorologicalData.csv", function (d) {
			return {
				Date: formatDate(new Date(d['Date'])),
				WindDirection: +d["Wind Direction"],
				WindSpeed: +d["Wind Speed (m/s)"],
				Elevation: +d["Elevation (m)"]
			};
		}).then(function(data1) {
			d3.csv("Data/SensorData.csv", function (d) {
			return {
				Date: formatDate(new Date(d['Date Time '])),
				Chemical: d["Chemical"],
				Monitor: +d["Monitor"],
				Reading: +d["Reading"]
			};
			}).then(function(data2) {
				console.log(data1);
				console.log(data2);
				var delay = 230;
				
				function windMapAnimation(){
				
					var dateText = svg.append("text")   
										.attr("font-size", 10)
										.attr("font-weight", "bold")
										.attr("fill", "black")
										.attr("x", 740)
										.attr("y", 25)
										.style("text-anchor", "left");
				
					var monthText = svg.append("text")   
										.attr("font-size", 15)
										.attr("font-weight", "bold")
										.attr("fill", "black")
										.attr("x", 740)
										.attr("y", 40)
										.style("text-anchor", "left");
										
					var windSpeedText = svg.append("text")   
										.attr("font-size", 20)
										.attr("font-weight", "bold")
										.attr("fill", "black")
										.attr("x", 1290)
										.attr("y", 30)
										.style("text-anchor", "left-side");
										
					var windDirectionArrow = svg.append("line")
												.style("stroke", "black")
												.attr("stroke-width", 2 )
												.attr("length", 10)
												.attr("x", 1080)
												.attr("y", 360);
	
					repeat();
				
					function repeat(){
						
						//Cycle through date time combos
						for (i=0; i<data1.length; i++){
							dateText.transition()
								.delay(i*delay)
								.text(data1[i].Date)
								.on("end", repeat);
								
							windSpeedText.transition()
								.delay(i*delay)
								.text((data1[i].WindSpeed) + "m/s")
								.on("end", repeat);
							
							//Creat date bject to extract month
							date = (new Date(data1[i].Date));
							
							//Assign delay for transition of month label to august
							if (date.getMonth() == 3){
								var augustDelay = (i+1)*delay
							}
							
							//Assign delay for transition of month label to december
							if (date.getMonth() == 7){
								var decemberDelay = (i+1)*delay;
							}
						}	
						
						//Set month label to April
						monthText.transition()
									.text("April");
									
						//Set month label to August			
						monthText.transition()
									.delay(augustDelay)
									.text("August");
									
						//Set month label to December
						monthText.transition()
									.delay(decemberDelay)
									.text("December");
	
					}
				}
				windMapAnimation();
			});
		});
	</script>
</body>
</html>